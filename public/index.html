<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>YouTube 動画検索サイト（試験運用）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      margin: 0;
      padding: 16px 0;
      background: #f5f5f5;
      color: #222;
      font-size: 18px; /* ★ PC 基準フォントサイズを大きめに */
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 16px 24px;
      background: #ffffff;
      border: 1px solid #ddd;
    }

    header {
      padding: 20px 0 10px;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 12px;
    }

    h1 {
      font-size: 26px;  /* ★ タイトルも少し大きめ */
      margin: 0 0 4px;
      font-weight: 600;
    }

    .subtitle {
      font-size: 15px;
      color: #666;
      margin: 0;
    }

    /* ナビゲーション */
    .nav {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 14px;
    }

    .nav button {
      border: 1px solid #bbb;
      background: #f4f4f4;
      padding: 7px 14px;
      font-size: 15px;
      cursor: pointer;
      border-radius: 0;
      min-width: 90px;
    }

    .nav button:hover {
      background: #e9e9e9;
    }

    .nav button:active {
      background: #ddd;
    }

    /* 共通ボックス */
    .box {
      margin-top: 14px;
      margin-bottom: 14px;
      padding: 10px 12px;
      border: 1px solid #ddd;
      background: #fafafa;
      font-size: 16px;
    }

    .note {
      margin-top: 6px;
      padding: 8px 10px;
      border: 1px solid #e0e0e0;
      background: #f8f8f8;
      font-size: 15px;
      line-height: 1.7;
    }

    .label {
      font-size: 15px;
      margin-bottom: 4px;
      display: block;
      font-weight: 500;
    }

    .input {
      width: 100%;
      padding: 9px 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 0;
    }

    .input:focus {
      outline: none;
      border-color: #666;
    }

    .button {
      margin-top: 8px;
      padding: 8px 18px;
      font-size: 16px;
      cursor: pointer;
      border: 1px solid #555;
      background: #ffffff;
      border-radius: 0;
      min-width: 120px;
    }

    .button:hover {
      background: #f0f0f0;
    }

    .button:active {
      background: #e0e0e0;
    }

    .button-small {
      margin-top: 6px;
      padding: 5px 11px;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid #777;
      background: #ffffff;
      border-radius: 0;
    }

    .button-small:hover {
      background: #f0f0f0;
    }

    .status-text {
      margin-top: 6px;
      font-size: 15px;
      color: #555;
    }

    .result-count {
      margin-top: 8px;
      font-size: 15px;
      color: #555;
    }

    /* 検索結果レイアウト */
    #results {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }

    .video-card {
      border: 1px solid #ddd;
      padding: 10px 10px;
      background: #fff;
      display: flex;
      flex-direction: column;
      height: 100%;
      font-size: 14px;
    }

    .video-title {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 15px;
      line-height: 1.4;
    }

    .video-url {
      margin-bottom: 4px;
      word-break: break-all;
    }

    .video-url a {
      font-size: 13px;
      color: #1565c0;
      text-decoration: none;
    }

    .video-url a:hover {
      text-decoration: underline;
    }

    .video-tags {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
      margin-bottom: 8px;
    }

    .video-player {
      margin-top: 8px;
    }

    .video-player img,
    .video-player iframe {
      width: 100% !important;
      height: auto;
      display: block;
    }

    .video-player img {
      object-fit: cover;
    }

    .video-player button {
      margin-top: 6px;
    }

    .more-container {
      margin-top: 14px;
      text-align: center;
      grid-column: 1 / -1; /* 全カラムをまたぐ */
    }

    .hidden {
      display: none;
    }

    /* ホームの操作ボックス */
    .home-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .home-actions .button {
      margin-top: 0;
    }

    /* スマホ向け調整（スマホではフォントを少し小さく戻す） */
    @media (max-width: 600px) {
      body {
        padding: 8px 0;
        font-size: 15px; /* ★ スマホでは標準サイズ寄りに */
      }
      .page {
        border-left: none;
        border-right: none;
        padding: 0 10px 16px;
      }
      header {
        padding-top: 14px;
      }
      h1 {
        font-size: 20px;
      }
      .subtitle {
        font-size: 13px;
      }
      .nav button {
        flex: 1 1 auto;
        text-align: center;
        font-size: 14px;
        padding: 6px 10px;
      }
      .box {
        font-size: 14px;
      }
      .note {
        font-size: 13px;
      }
      .input {
        font-size: 15px;
      }
      .button {
        font-size: 15px;
      }
      #results {
        grid-template-columns: 1fr;  /* 1列表示 */
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>YouTube 動画検索サイト（開発中）</h1>
      <p class="subtitle">
        限定公開／公開動画をまとめて検索するための内部ツールです。関係者以外の共有はご遠慮ください
      </p>

      <!-- ナビゲーション -->
      <div class="nav">
        <button id="navHome">ホーム</button>
        <button id="navSearch">検索</button>
        <button id="navAdmin">管理者画面</button>
      </div>
    </header>

    <!-- ホーム画面 -->
    <div id="homeSection">
      <div class="note">
        <strong>現在の状態：</strong><br />
        ・このサイトは市川左次郎が作成管理し、土橋慶一が動画管理しております<br />
        ・何か不具合や要望がございましたら管理者までご連絡ください<br />
        ・検索は「タイトル＋タグ」に対して、かな／カナの違いと簡単な同義語対応<br />
        ・別称（通称や外題名、タグ）編集は誰でも可能です（検索結果から「別称を追加」ボタン）<br />
        ・"この動画を再生"ボタンを押すことでもyoutubeが起動します<br />
        ・検索結果は 1ページ 50件ずつ表示、「もっと表示」で追加読み込みします<br />
      </div>

      <div class="box">
        <p>行いたい作業を選んでください。</p>
        <div class="home-actions">
          <button id="goSearch" class="button">検索する</button>
        </div>
      </div>
    </div>

    <!-- 検索画面 -->
    <div id="searchSection" class="hidden">
      <div class="box">
        <span class="label">検索ワード（例：勧進帳、高島屋、平成元年など）</span>
        <input
          id="searchInput"
          type="text"
          class="input"
          placeholder="タイトル or 別称に含まれる文字で検索"
        />
        <div id="resultCount" class="result-count"></div>
      </div>

      <div id="results"></div>
    </div>

    <!-- 管理者画面 -->
    <div id="adminSection" class="hidden">
      <!-- ログインフォーム -->
      <div class="box" id="adminLoginBox">
        <span class="label">管理者ログイン</span>
        <input
          id="adminPasswordInput"
          type="password"
          class="input"
          placeholder="管理者パスワード"
        />
        <button id="adminLoginButton" class="button">ログイン</button>
        <div id="adminLoginMessage" class="status-text"></div>
      </div>

      <!-- ログイン後にだけ表示する領域 -->
      <div id="adminContentBox" class="hidden">
        <div class="box">
          <div class="status-text">
            管理者としてログイン中です。新規登録などの操作ができます。
            <button
              id="adminLogoutButton"
              class="button-small"
              style="margin-left: 8px;"
            >
              ログアウト
            </button>
          </div>
        </div>

        <!-- 一本動画の新規登録 -->
        <div class="box">
          <span class="label">一本動画の新規登録</span>
          <input
            id="registerVideoUrl"
            type="text"
            class="input"
            placeholder="https://www.youtube.com/watch?v=... または https://youtu.be/..."
          />
          <button id="registerVideoButton" class="button">動画を登録</button>
          <div id="registerVideoMessage" class="status-text"></div>
        </div>

        <!-- 再生リストの新規登録 -->
        <div class="box">
          <span class="label">
            再生リストの新規登録（他人のチャンネルでもOK・公開/限定公開対応）
          </span>
          <input
            id="registerPlaylistUrl"
            type="text"
            class="input"
            placeholder="https://www.youtube.com/playlist?list=... または watch?v=...&list=..."
          />
          <button id="registerPlaylistButton" class="button">
            再生リストの動画を登録
          </button>
          <div id="registerPlaylistMessage" class="status-text"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== セクション切り替え =====
    const homeSection = document.getElementById("homeSection");
    const searchSection = document.getElementById("searchSection");
    const adminSection = document.getElementById("adminSection");

    const navHome = document.getElementById("navHome");
    const navSearch = document.getElementById("navSearch");
    const navAdmin = document.getElementById("navAdmin");
    const goSearch = document.getElementById("goSearch");

    function showSection(name) {
      homeSection.classList.add("hidden");
      searchSection.classList.add("hidden");
      adminSection.classList.add("hidden");

      if (name === "home") {
        homeSection.classList.remove("hidden");
      } else if (name === "search") {
        searchSection.classList.remove("hidden");
      } else if (name === "admin") {
        adminSection.classList.remove("hidden");
      }
    }

    navHome.addEventListener("click", () => showSection("home"));
    navSearch.addEventListener("click", () => showSection("search"));
    navAdmin.addEventListener("click", () => showSection("admin"));
    goSearch.addEventListener("click", () => showSection("search"));

    // ===== クライアント状態 =====
    let videos = [];
    let filteredVideos = [];
    let currentPage = 1;
    const PAGE_SIZE = 50;
    let isAdmin = false; // 管理者かどうか（新規登録UI用）

    // 簡易シソーラス
    const synonymMap = {
      "ねこ": ["ねこ", "ネコ", "猫"],
      "ネコ": ["ねこ", "ネコ", "猫"],
      "猫": ["ねこ", "ネコ", "猫"],
    };

    // DOM
    const searchInput = document.getElementById("searchInput");
    const resultsDiv = document.getElementById("results");
    const resultCount = document.getElementById("resultCount");

    const adminPasswordInput = document.getElementById("adminPasswordInput");
    const adminLoginButton = document.getElementById("adminLoginButton");
    const adminLoginMessage = document.getElementById("adminLoginMessage");
    const adminLogoutButton = document.getElementById("adminLogoutButton");
    const adminLoginBox = document.getElementById("adminLoginBox");
    const adminContentBox = document.getElementById("adminContentBox");

    const registerVideoUrlInput = document.getElementById("registerVideoUrl");
    const registerVideoButton = document.getElementById("registerVideoButton");
    const registerVideoMessage = document.getElementById("registerVideoMessage");

    const registerPlaylistUrlInput =
      document.getElementById("registerPlaylistUrl");
    const registerPlaylistButton = document.getElementById(
      "registerPlaylistButton"
    );
    const registerPlaylistMessage = document.getElementById(
      "registerPlaylistMessage"
    );

    // ===== 日本語正規化 =====
    function katakanaToHiragana(str) {
      return str.replace(/[\u30a1-\u30f6]/g, (ch) =>
        String.fromCharCode(ch.charCodeAt(0) - 0x60)
      );
    }

    function normalizeJa(str) {
      let s = (str || "").trim();
      s = s.toLowerCase();
      s = katakanaToHiragana(s);
      return s;
    }

    // ===== YouTube 埋め込み用 =====
    function extractYoutubeId(urlStr) {
      try {
        const u = new URL(urlStr);
        const host = u.hostname.toLowerCase();

        if (host === "youtu.be") {
          return u.pathname.replace("/", "");
        }
        if (host.endsWith("youtube.com")) {
          const v = u.searchParams.get("v");
          if (v) return v;
        }
      } catch (e) {
        return null;
      }
      return null;
    }

    // ===== API通信 =====
    async function fetchVideos() {
      try {
        const resp = await fetch("/api/videos");
        const data = await resp.json();
        videos = data.videos || [];
        applySearch(); // 初回は検索条件なしで全件
      } catch (e) {
        console.error("動画一覧の取得に失敗:", e);
        if (resultsDiv) resultsDiv.textContent =
          "動画一覧の取得に失敗しました。";
        if (resultCount) resultCount.textContent = "";
      }
    }

    async function fetchAdminStatus() {
      try {
        const resp = await fetch("/api/admin/status");
        const data = await resp.json();
        isAdmin = !!data.isAdmin;
        renderAdminUI();
      } catch (e) {
        console.error("admin status error:", e);
      }
    }

    async function registerVideo() {
      const url = registerVideoUrlInput.value.trim();
      if (!url) {
        registerVideoMessage.textContent = "URLを入力してください。";
        return;
      }
      registerVideoMessage.textContent = "登録中...";

      try {
        const resp = await fetch("/api/register/video", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ videoUrl: url }),
        });
        const data = await resp.json();
        if (!resp.ok) {
          registerVideoMessage.textContent =
            `エラー: ${data.error || "登録に失敗しました"}`;
          return;
        }

        if (data.alreadyExisted) {
          registerVideoMessage.textContent =
            `登録済みの動画です: ${data.title}`;
        } else {
          registerVideoMessage.textContent = `登録しました: ${data.title}`;
        }

        registerVideoUrlInput.value = "";
        await fetchVideos();
      } catch (e) {
        console.error(e);
        registerVideoMessage.textContent = "通信エラーが発生しました。";
      }
    }

    async function registerPlaylist() {
      const url = registerPlaylistUrlInput.value.trim();
      if (!url) {
        registerPlaylistMessage.textContent =
          "再生リストのURLを入力してください。";
        return;
      }
      registerPlaylistMessage.textContent = "再生リストから取得中...";

      try {
        const resp = await fetch("/api/register/playlist", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ playlistUrl: url }),
        });
        const data = await resp.json();
        if (!resp.ok) {
          registerPlaylistMessage.textContent =
            `エラー: ${data.error || "再生リスト登録に失敗しました"}`;
          return;
        }

        registerPlaylistMessage.textContent =
          `取得件数: ${data.fetched} / 新規登録: ${data.inserted} / 既存: ${data.skipped}`;

        registerPlaylistUrlInput.value = "";
        await fetchVideos();
      } catch (e) {
        console.error(e);
        registerPlaylistMessage.textContent = "通信エラーが発生しました。";
      }
    }

    async function updateTags(videoId, tagsText) {
      const resp = await fetch("/api/videos/update-tags", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: videoId, tagsText }),
      });
      const data = await resp.json();
      if (!resp.ok || !data.ok) {
        throw new Error(data.error || "タグ更新に失敗しました");
      }
    }

    // ===== 管理者UI =====
    function renderAdminUI() {
      if (isAdmin) {
        adminLoginBox.classList.add("hidden");
        adminContentBox.classList.remove("hidden");
      } else {
        adminLoginBox.classList.remove("hidden");
        adminContentBox.classList.add("hidden");
      }
    }

    adminLoginButton.addEventListener("click", async () => {
      const pw = adminPasswordInput.value.trim();
      if (!pw) {
        adminLoginMessage.textContent =
          "パスワードを入力してください。";
        return;
      }
      adminLoginMessage.textContent = "ログイン中...";

      try {
        const resp = await fetch("/api/admin/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password: pw }),
        });
        const data = await resp.json();
        if (resp.ok && data.ok) {
          isAdmin = true;
          adminPasswordInput.value = "";
          adminLoginMessage.textContent = "ログインしました。";
          renderAdminUI();
        } else {
          adminLoginMessage.textContent =
            data.error || "ログインに失敗しました。";
        }
      } catch (e) {
        console.error(e);
        adminLoginMessage.textContent = "通信エラーが発生しました。";
      }
    });

    adminLogoutButton.addEventListener("click", async () => {
      try {
        await fetch("/api/admin/logout", { method: "POST" });
      } catch (e) {
        console.error(e);
      }
      isAdmin = false;
      renderAdminUI();
    });

    // ===== 検索 =====
    function applySearch() {
      const raw = ((searchInput && searchInput.value) || "").trim();

      let filtered;
      if (raw === "") {
        filtered = videos.slice();
      } else {
        const normalizedRaw = normalizeJa(raw);
        let queryCandidates = [raw];

        for (const [key, group] of Object.entries(synonymMap)) {
          if (normalizeJa(key) === normalizedRaw) {
            queryCandidates = group;
            break;
          }
        }
        const normalizedCandidates = queryCandidates.map((q) =>
          normalizeJa(q)
        );

        filtered = videos.filter((video) => {
          const tags = video.tags || [];
          const haystack = normalizeJa(
            (video.title || "") + " " + tags.join(" ")
          );
          return normalizedCandidates.some((q) => haystack.includes(q));
        });
      }

      filteredVideos = filtered;
      currentPage = 1;
      renderResults();
    }

    function renderResults() {
      if (!resultsDiv || !resultCount) return;

      resultsDiv.innerHTML = "";

      const totalHits = filteredVideos.length;
      const shownCount = Math.min(totalHits, currentPage * PAGE_SIZE);
      const listToShow = filteredVideos.slice(0, shownCount);

      resultCount.textContent =
        `ヒット件数: ${totalHits} / 表示件数: ${shownCount} / 登録件数: ${videos.length}`;

      if (listToShow.length === 0) {
        resultsDiv.textContent = "該当する動画がありません。";
        return;
      }

      listToShow.forEach((video) => {
        const card = document.createElement("div");
        card.className = "video-card";

        const title = document.createElement("div");
        title.className = "video-title";
        title.textContent = video.title;

        const urlDiv = document.createElement("div");
        urlDiv.className = "video-url";
        const link = document.createElement("a");
        link.href = video.url;
        link.target = "_blank";
        link.rel = "noopener noreferrer";
        link.textContent = video.url;
        urlDiv.appendChild(link);

        const tagsDiv = document.createElement("div");
        tagsDiv.className = "video-tags";
        const tags =
          video.tags && video.tags.length > 0
            ? video.tags.join(", ")
            : "なし";
        tagsDiv.textContent = "タグ: " + tags;

        card.appendChild(title);
        card.appendChild(urlDiv);
        card.appendChild(tagsDiv);

        // タグ編集ボタン（誰でも可）
        const editBtn = document.createElement("button");
        editBtn.className = "button-small";
        editBtn.textContent = "別称編集";
        editBtn.addEventListener("click", async () => {
          const current = (video.tags || []).join(", ");
          const input = window.prompt(
            ` ${video.title}\nの別称を点（、）で区切りをつけて入力してください:`,
            current
          );
          if (input === null) return;
          try {
            await updateTags(video.id, input);
            await fetchVideos();
          } catch (e) {
            console.error(e);
            window.alert("別称、タグ更新に失敗しました。");
          }
        });
        card.appendChild(editBtn);

        // サムネ → クリックしたときだけ iframe をロード
        const videoId = extractYoutubeId(video.url);
        if (videoId) {
          const playerDiv = document.createElement("div");
          playerDiv.className = "video-player";

          const thumb = document.createElement("img");
          thumb.src = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
          thumb.alt = video.title;
          thumb.style.cursor = "pointer";

          const playBtn = document.createElement("button");
          playBtn.className = "button-small";
          playBtn.textContent = "▶ この動画を再生";

          function loadIframe() {
            if (playerDiv.dataset.loaded === "1") return;
            playerDiv.dataset.loaded = "1";
            playerDiv.innerHTML = "";

            const iframe = document.createElement("iframe");
            iframe.width = "100%";
            iframe.height = "100%";
            iframe.src = `https://www.youtube.com/embed/${videoId}`;
            iframe.title = "YouTube video player";
            iframe.frameBorder = "0";
            iframe.allow =
              "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
            iframe.allowFullscreen = true;
            iframe.loading = "lazy";

            playerDiv.appendChild(iframe);
          }

          thumb.addEventListener("click", loadIframe);
          playBtn.addEventListener("click", loadIframe);

          playerDiv.appendChild(thumb);
          playerDiv.appendChild(playBtn);
          card.appendChild(playerDiv);
        }

        resultsDiv.appendChild(card);
      });

      if (shownCount < totalHits) {
        const moreDiv = document.createElement("div");
        moreDiv.className = "more-container";

        const moreBtn = document.createElement("button");
        moreBtn.className = "button";
        moreBtn.textContent = "もっと表示（さらに50件）";
        moreBtn.addEventListener("click", () => {
          currentPage += 1;
          renderResults();
        });

        moreDiv.appendChild(moreBtn);
        resultsDiv.appendChild(moreDiv);
      }
    }

    // ===== イベント & 初期化 =====
    if (searchInput) {
      searchInput.addEventListener("input", applySearch);
    }
    if (registerVideoButton) {
      registerVideoButton.addEventListener("click", registerVideo);
    }
    if (registerPlaylistButton) {
      registerPlaylistButton.addEventListener("click", registerPlaylist);
    }

    showSection("home");
    fetchVideos();
    fetchAdminStatus();
  </script>
</body>
</html>
